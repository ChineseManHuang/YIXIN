# Architecture Decisions - 意心AI心理咨询平台

本文档记录项目中做出的重要架构决策及其原因。

---

## ADR-001: 技术栈选择

**日期:** 2024年初
**状态:** 已实施

### 决策
采用以下技术栈:
- 前端: React + TypeScript + Vite + Tailwind CSS
- 后端: Node.js + Express + TypeScript
- 数据库: Supabase (PostgreSQL)
- AI: 阿里云百炼 (qwen-turbo, qwen3-omni-flash-realtime)
- 部署: Vercel

### 背景
需要快速构建一个AI心理咨询平台，支持文字和语音交互。

### 理由
1. **React + TypeScript**: 类型安全，生态丰富，团队熟悉
2. **Vite**: 比webpack更快的开发体验
3. **Tailwind CSS**: 快速构建UI，减少CSS文件
4. **Supabase**: 提供数据库+认证+实时功能的完整方案
5. **百炼API**: 国内访问稳定，支持多模态（文字+语音）
6. **Vercel**: 零配置部署，适合全栈应用

### 后果
- ✅ 开发速度快
- ✅ 类型安全减少bug
- ✅ Supabase简化后端逻辑
- ⚠️ 对百炼API依赖性强
- ⚠️ Vercel Serverless有冷启动问题

---

## ADR-002: Zustand替代Redux

**日期:** 2024年初
**状态:** 已实施

### 决策
使用Zustand作为全局状态管理工具，而非Redux或Context API。

### 背景
需要管理用户认证状态等全局状态。

### 理由
1. **简洁性**: API极简，无需boilerplate
2. **性能**: 组件只在使用的状态改变时重新渲染
3. **TypeScript支持**: 类型推断良好
4. **包大小**: 仅2KB，远小于Redux

### 对比
| 方案 | 优点 | 缺点 |
|------|------|------|
| Redux | 成熟生态，DevTools | 繁琐的boilerplate |
| Context API | React内置 | 性能问题，嵌套地狱 |
| **Zustand** | 简洁，性能好 | 生态较小 |

### 后果
- ✅ 代码更简洁
- ✅ 开发效率提升
- ⚠️ 团队需要学习新工具（学习曲线低）

---

## ADR-003: 单页应用(SPA)架构

**日期:** 2024年初
**状态:** 已实施

### 决策
采用SPA架构，所有路由在客户端处理。

### 背景
需要提供流畅的用户体验，减少页面刷新。

### 理由
1. **用户体验**: 无页面刷新，类原生应用体验
2. **前后端分离**: API可被多端复用
3. **部署简单**: 静态文件+API，易于缓存
4. **React Router**: 成熟的客户端路由方案

### 替代方案
- **SSR (Next.js)**: 更好的SEO，但本项目无SEO需求
- **MPA**: 简单但用户体验差

### 后果
- ✅ 交互流畅
- ✅ 前后端职责清晰
- ⚠️ 首次加载较慢（已通过代码分割优化）
- ⚠️ SEO较差（但心理咨询平台无SEO需求）

---

## ADR-004: KB01-05线性工作流

**日期:** 2024年中
**状态:** 已实施

### 决策
咨询流程严格按照KB-01 -> KB-02 -> KB-03 -> KB-04 -> KB-05线性推进。

### 背景
需要一个结构化的咨询框架，基于图式治疗(Schema Therapy)和ACT。

### 理由
1. **专业性**: 遵循心理学理论框架
2. **可控性**: 避免对话发散，确保咨询质量
3. **可追踪**: 用户进度可视化
4. **可优化**: 每个阶段独立优化

### KB阶段划分
1. **KB-01**: 早期不良图式介绍 - 建立信任
2. **KB-02**: 森林隐喻 - 探索图式来源
3. **KB-03**: YSQ问答 - 识别具体图式
4. **KB-04**: 层级化触发 - 分析应对模式
5. **KB-05**: RNT评估 - 总结和规划

### 替代方案
- **自由对话**: 灵活但难以控制质量
- **规则引擎**: 复杂但可能过于机械

### 后果
- ✅ 咨询质量可控
- ✅ 进度可视化
- ✅ 便于数据分析
- ⚠️ 灵活性受限
- ⚠️ 可能不适合所有用户

---

## ADR-005: RAG知识库架构

**日期:** 2024年中
**状态:** 已实施

### 决策
使用本地Markdown文件作为RAG知识库，在服务器启动时加载到内存。

### 背景
需要为AI提供专业心理学知识和咨询指导。

### 理由
1. **简单性**: 无需向量数据库，降低复杂度
2. **可维护性**: Markdown易于编辑和版本控制
3. **性能**: 内存加载，无需额外查询
4. **成本**: 无需第三方向量数据库服务

### 知识库内容
```
rag/
├── KB-01_EMS_Intro.md
├── KB-02_Forest_Metaphor_River_Two_Forests.md
├── KB-03_YSQ-S3_Forest_Questions.md
├── KB-04_Hierarchical_Trigger_Dynamite_Tree.md
├── KB-05_RNT_Assessment_Hierarchical_Trigger.md
├── ethics_rag.md
└── act_rag_cards.md
```

### 未来优化方向
- 引入向量数据库（Supabase pgvector）
- 实现语义搜索
- 跨会话记忆检索

### 后果
- ✅ 实现简单快速
- ✅ 维护方便
- ⚠️ 无法处理大规模知识库
- ⚠️ 无语义搜索能力

---

## ADR-006: 纯语音交互界面

**日期:** 2025年1月
**状态:** 已实施

### 决策
为语音咨询创建独立的纯语音交互界面，完全去除对话框和文字输入。

### 背景
现有的Consultation.tsx仍然保留对话框，与真实心理咨询场景不符。

### 理由
1. **沉浸感**: 模拟真实咨询场景（面对面，不看屏幕）
2. **专注度**: 减少视觉干扰，让用户专注于语音交流
3. **差异化**: 区别于传统聊天机器人
4. **专业性**: 体现心理咨询的仪式感

### 核心设计
- **大圆形按钮**: 直径192px，唯一交互元素
- **状态反馈**: 颜色+图标+动画（录音/说话/处理）
- **文字显示**: AI回复以文字形式显示在屏幕上方
- **无对话历史**: 只显示当前AI回复

### 替代方案
| 方案 | 优点 | 缺点 |
|------|------|------|
| 保留对话框 | 用户熟悉 | 不够沉浸 |
| 混合模式 | 灵活 | 定位不清晰 |
| **纯语音** | 沉浸感强 | 无法回看历史 |

### 后果
- ✅ 用户体验独特
- ✅ 更专注于对话本身
- ⚠️ 无法回看历史消息（可考虑添加回放功能）
- ⚠️ 可能不适合所有用户（可提供切换选项）

---

## ADR-007: AI主动引导对话

**日期:** 2025年1月
**状态:** 已实施

### 决策
AI在会话开始时主动问候并引导用户，而非等待用户先发言。

### 背景
传统聊天机器人都是被动响应，不符合真实心理咨询场景。

### 理由
1. **真实性**: 真实的心理咨询师会主动开启对话
2. **降低门槛**: 减少用户的心理障碍（不知道说什么）
3. **专业性**: 体现AI的主动性和引导能力
4. **一致性**: 与KB线性工作流一致

### 实现方式
```typescript
// 根据KB阶段生成不同问候语
const greetings = {
  1: '你好，我是你的AI心理咨询师...',
  2: '欢迎回来。上次我们探讨了...',
  3: '很高兴再次见到你...',
  4: '你好。今天我们将一起探索...',
  5: '欢迎。我们已经走过了很多阶段...'
}

// 在客户端直接设置并播放，无需API调用
setCurrentAIMessage(greeting)
speakText(greeting)
```

### 后果
- ✅ 用户体验更自然
- ✅ 降低使用门槛
- ✅ 体现专业性
- ⚠️ 需要精心设计问候语

---

## ADR-008: 语音API Fallback策略

**日期:** 2025年1月
**状态:** 已实施

### 决策
语音API调用失败时自动回退到文本API，确保基本功能可用。

### 背景
百炼语音API可能未完全配置或不稳定，导致语音功能完全不可用。

### 理由
1. **可用性优先**: 即使无语音识别，基本对话仍可进行
2. **渐进增强**: 从文本API开始，逐步增强到语音API
3. **用户友好**: 避免因API问题导致服务完全不可用
4. **开发便利**: 在百炼API配置完成前仍可测试

### 实现
```typescript
try {
  // 尝试调用语音API
  const voiceResponse = await bailianService.generateVoiceCounselingResponse(...)
  // 处理语音结果
} catch (error) {
  console.error('Voice processing error, falling back to text mode:', error)

  // Fallback: 使用文本API
  userTranscript = '[语音消息 - 暂时无法转写]'
  const textResponse = await bailianService.generateCounselingResponse(...)
  aiResponseText = textResponse.response
  // 不返回音频，前端使用浏览器TTS
}
```

### 后果
- ✅ 服务可用性提升
- ✅ 开发测试更方便
- ⚠️ 用户看不到自己说了什么（显示占位符）
- ⚠️ 需要长期替换为真实ASR

---

## ADR-009: 客户端问候逻辑

**日期:** 2025年1月
**状态:** 已实施

### 决策
AI初始问候在客户端生成和播放，不调用后端API。

### 背景
初始问候是固定的，无需AI生成，但之前的实现会调用API并保存到数据库。

### 理由
1. **性能**: 避免不必要的网络请求和数据库写入
2. **响应速度**: 问候立即播放，无需等待API
3. **成本**: 减少API调用次数
4. **简洁**: 固定文本无需AI生成

### 实现
```typescript
const initiateAIGreeting = (sessionData: Session) => {
  const greetings = { /* ... */ }
  const greeting = greetings[sessionData.current_kb_step]

  // 直接设置并播放，不调用API
  setCurrentAIMessage(greeting)
  speakText(greeting)
}
```

### 后果
- ✅ 响应更快
- ✅ 减少API调用
- ✅ 节省成本
- ⚠️ 问候语不能动态调整（但可以根据KB阶段变化）

---

## ADR-010: Supabase作为BaaS

**日期:** 2024年初
**状态:** 已实施

### 决策
使用Supabase作为后端即服务(BaaS)平台，而非自建PostgreSQL。

### 背景
需要快速搭建后端基础设施（数据库+认证+API）。

### 理由
1. **开发速度**: 认证、数据库、API开箱即用
2. **安全性**: 内置RLS(行级安全)
3. **实时功能**: WebSocket实时订阅
4. **成本**: 免费额度足够MVP使用
5. **开发体验**: 优秀的管理界面和文档

### 功能使用
- ✅ PostgreSQL数据库
- ✅ 用户认证(Auth)
- ✅ 行级安全(RLS)
- ⚠️ 实时订阅(未充分利用)
- ⚠️ Storage(未使用)

### 后果
- ✅ 极大缩短开发周期
- ✅ 安全性有保障
- ⚠️ 供应商锁定风险
- ⚠️ 复杂查询性能可能受限

---

## ADR-011: Vercel Serverless部署

**日期:** 2024年初
**状态:** 已实施

### 决策
使用Vercel部署前端和后端API（Serverless Functions）。

### 背景
需要快速部署和持续集成。

### 理由
1. **零配置**: Git推送自动部署
2. **全球CDN**: 前端资源加速
3. **Serverless**: 无需管理服务器
4. **预览环境**: 每个PR自动创建预览
5. **成本**: 个人项目免费额度充足

### 限制
- Serverless函数10秒超时（业余版）
- 冷启动延迟
- 不适合长连接（WebSocket）

### 后果
- ✅ 部署极其简单
- ✅ CI/CD开箱即用
- ⚠️ 冷启动问题（可通过预热缓解）
- ⚠️ WebSocket受限（未来实时语音需考虑）

---

## 待决策事项

### PD-001: 向量数据库选择
**状态:** 待讨论

**背景:** 需要实现会话历史RAG和跨会话记忆

**选项:**
1. **Supabase pgvector** - 集成简单，但性能未知
2. **Pinecone** - 专业向量数据库，但额外成本
3. **Weaviate** - 开源，但需要自托管

**决策依据:**
- 查询性能
- 成本
- 维护复杂度
- 与现有系统集成难度

---

### PD-002: 实时语音方案
**状态:** 待讨论

**背景:** 需要实现真正的全双工实时语音对话

**选项:**
1. **WebRTC + WebSocket** - 标准方案，但实现复杂
2. **百炼实时语音API** - 如果支持
3. **第三方服务** - 如Agora、声网

**决策依据:**
- 技术复杂度
- 延迟和音质
- 成本
- 维护性

---

### PD-003: 语音识别服务
**状态:** 待讨论

**背景:** 当前使用占位符，需要真实ASR

**选项:**
1. **百炼ASR** - 集成简单，但文档不清楚
2. **阿里云智能语音交互** - 稳定但额外成本
3. **浏览器Web Speech API** - 免费但兼容性问题

**决策依据:**
- 识别准确率
- 成本
- 延迟
- 浏览器兼容性
