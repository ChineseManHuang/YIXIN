# 语音咨询功能说明

## 功能概述

全新的语音咨询界面为用户提供了沉浸式的AI心理咨询体验，完全不同于传统的文字对话框模式。

## 主要特点

### 1. AI主动发起对话
- 会话开始时，AI咨询师会主动问候并引导用户
- 根据当前KB阶段(KB01-05)自动调整问候语和引导策略
- 模拟真实心理咨询师的主动引导风格

### 2. 纯语音交互界面
- 去除传统对话框设计
- 采用大圆形语音图标作为核心交互元素(直径192px)
- 视觉简洁，专注于对话本身

### 3. 实时状态反馈
- **录音状态**: 红色脉动圆形，显示"正在录音"
- **AI说话状态**: 绿色圆形，显示"AI正在说话"
- **处理状态**: 黄色圆形，显示"正在处理"
- **待命状态**: 蓝紫渐变，邀请用户开始对话

### 4. 文字与语音同步
- AI回复会以文字形式显示在屏幕上方
- 同时播放语音(支持阿里云百炼TTS或浏览器TTS)
- 用户可以边听边阅读，增强理解

### 5. KB01-05线性工作流
严格按照心理咨询的5个阶段推进：
- **KB-01**: 早期不良图式介绍和信任建立
- **KB-02**: 森林隐喻和深度探索
- **KB-03**: YSQ森林问答
- **KB-04**: 层级化触发分析
- **KB-05**: RNT评估和总结

## 使用流程

### 从Dashboard创建语音咨询
1. 登录后进入Dashboard
2. 点击"语音咨询"按钮(紫色按钮)
3. 系统自动创建新的语音咨询会话
4. 进入语音咨询界面

### 进行语音对话
1. **听取AI问候**: 进入后AI会自动问候并开始引导
2. **点击录音**: 点击中央大圆形按钮开始录音
3. **说话**: 向麦克风说出你的回答或问题
4. **停止录音**: 再次点击按钮停止录音并发送
5. **等待处理**: 系统处理你的语音输入
6. **接收回复**: AI回复会显示文字并播放语音
7. **继续对话**: 重复步骤2-6

### 界面元素

#### 头部导航
- 返回按钮: 返回Dashboard
- 会话标题
- KB进度指示器: 5个小圆点显示当前阶段
- 语音模式标签

#### 中央区域
- **AI文字显示区**: 白色卡片显示AI最新回复
- **语音图标**: 大圆形按钮，核心交互元素
- **状态提示**: 图标下方显示当前状态文字

#### 底部
- 功能说明文字

## 技术实现

### 前端组件
- `src/pages/VoiceConsultation.tsx`: 语音咨询主组件
- 使用MediaRecorder API录音
- 支持Web Audio API和Speech Synthesis API
- 响应式设计，支持移动端和桌面端

### 后端API
- `/api/messages/voice`: 语音消息处理接口
- 集成阿里云百炼语音模型(qwen3-omni-flash-realtime)
- 自动语音识别(ASR)和文本转语音(TTS)

### RAG知识库
- KB01-05 Markdown文件存储于 `rag/` 目录
- 动态加载和解析工作流、问题清单、注意事项
- 伦理检查和风险评估

## 路由配置

```typescript
// 语音咨询路由
/consultation/:sessionId
```

## 与文字咨询的区别

| 特性 | 文字咨询 (/chat) | 语音咨询 (/consultation) |
|------|-----------------|-------------------------|
| 交互方式 | 文字输入框 | 语音录音 |
| 界面风格 | 对话气泡列表 | 大圆形按钮 |
| AI行为 | 被动回复 | 主动引导 |
| 历史消息 | 完整滚动列表 | 仅显示当前AI回复 |
| 适用场景 | 详细记录、深度思考 | 即时交流、情绪表达 |

## 浏览器兼容性

### 必需权限
- 麦克风访问权限
- 自动播放音频权限

### 推荐浏览器
- Chrome 90+
- Edge 90+
- Firefox 88+
- Safari 14+ (部分功能可能受限)

### 移动端支持
- iOS Safari: 需要用户手动授权麦克风
- Android Chrome: 完全支持
- 微信内置浏览器: 可能需要特殊配置

## 未来改进方向

1. **实时语音对话**: 实现真正的实时双向语音通信
2. **多语言支持**: 支持英语、日语等其他语言
3. **语音情绪分析**: 分析用户语音中的情绪状态
4. **会话回放**: 支持回放历史语音对话
5. **离线模式**: 支持离线录音后上传

## 故障排除

### 无法录音
- 检查浏览器麦克风权限
- 确保使用HTTPS连接(本地开发使用localhost除外)
- 检查系统麦克风是否被其他应用占用

### 音频播放失败
- 检查浏览器自动播放策略
- 尝试手动点击页面后再进行对话
- 查看浏览器控制台错误信息

### AI回复缓慢
- 检查网络连接
- 验证后端API配置(BAILIAN_API_KEY等)
- 查看服务器日志

## 开发者注意事项

### 环境变量
```bash
BAILIAN_ENDPOINT=https://dashscope.aliyuncs.com
BAILIAN_API_KEY=your_api_key_here
```

### 调试模式
在浏览器控制台查看详细日志：
- `[百炼服务]`: 后端API调用
- `[RAG加载器]`: 知识库加载
- `录音/播放相关`: 前端音频处理

---

**版本**: 1.0
**更新日期**: 2025年
